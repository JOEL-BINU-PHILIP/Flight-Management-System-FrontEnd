<div class="container mt-4">
  
  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="text-center" style="padding: 100px;">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <p class="mt-3">Loading flight details...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage && ! isLoading" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <!-- Main Booking Form (only show when flight is loaded) -->
  <div *ngIf="selectedFlight && ! isLoading">
    <div class="row justify-content-center">
      <div class="col-md-10">
        
        <!-- Flight Summary Card -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Flight Details</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <p><strong>Flight: </strong> {{ selectedFlight.airlineName }} - {{ selectedFlight.flightNumber }}</p>
                <p><strong>Route:</strong> {{ selectedFlight. fromPlace }} → {{ selectedFlight.toPlace }}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Departure:</strong> {{ formatDateTime(selectedFlight.departureTime) }}</p>
                <p><strong>Price per seat:</strong> ₹{{ selectedFlight.price }}</p>
                <p><strong>Available Seats:</strong> {{ selectedFlight.availableSeats }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Booking Form Card -->
        <div class="card shadow">
          <div class="card-header bg-success text-white">
            <h4 class="mb-0">Book Your Flight</h4>
          </div>
          <div class="card-body">
            <form [formGroup]="bookingForm" (ngSubmit)="onSubmit()">
              
              <!-- User Email -->
              <div class="mb-4">
                <label for="email" class="form-label">Email Address *</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  formControlName="email"
                  placeholder="Enter your email"
                  [class.is-invalid]="bookingForm.get('email')?.invalid && bookingForm.get('email')?.touched"
                />
                <div class="invalid-feedback" *ngIf="bookingForm.get('email')?.invalid && bookingForm.get('email')?.touched">
                  <span *ngIf="bookingForm.get('email')?.errors?.['required']">Email is required</span>
                  <span *ngIf="bookingForm.get('email')?.errors?.['email']">Please enter a valid email</span>
                </div>
              </div>

              <!-- Passengers Section -->
              <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5>Passenger Details</h5>
                  <button 
                    type="button" 
                    class="btn btn-outline-primary btn-sm"
                    (click)="addPassenger()"
                    [disabled]="passengers. length >= selectedFlight.availableSeats"
                  >
                    Add Passenger
                  </button>
                </div>

                <div formArrayName="passengers">
                  <div *ngFor="let passenger of passengers. controls; let i = index" class="card mb-3">
                    <div class="card-header bg-light">
                      <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Passenger {{ i + 1 }}</h6>
                        <button 
                          type="button" 
                          class="btn btn-sm btn-danger"
                          (click)="removePassenger(i)"
                          [disabled]="passengers.length === 1"
                        >
                          Remove
                        </button>
                      </div>
                    </div>
                    <div class="card-body" [formGroupName]="i">
                      <div class="row">
                        <!-- Name -->
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Full Name *</label>
                          <input
                            type="text"
                            class="form-control"
                            formControlName="name"
                            placeholder="Enter passenger name"
                            [class.is-invalid]="passenger.get('name')?.invalid && passenger.get('name')?.touched"
                          />
                          <div class="invalid-feedback">Name is required</div>
                        </div>

                        <!-- Gender -->
                        <div class="col-md-3 mb-3">
                          <label class="form-label">Gender *</label>
                          <select
                            class="form-select"
                            formControlName="gender"
                            [class.is-invalid]="passenger.get('gender')?.invalid && passenger.get('gender')?.touched"
                          >
                            <option value="">Select</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                          </select>
                          <div class="invalid-feedback">Gender is required</div>
                        </div>

                        <!-- Age -->
                        <div class="col-md-3 mb-3">
                          <label class="form-label">Age *</label>
                          <input
                            type="number"
                            class="form-control"
                            formControlName="age"
                            placeholder="Age"
                            min="1"
                            max="120"
                            [class.is-invalid]="passenger.get('age')?.invalid && passenger.get('age')?.touched"
                          />
                          <div class="invalid-feedback">Valid age required</div>
                        </div>

                        <!-- Seat Number -->
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Seat Number *</label>
                          <input
                            type="text"
                            class="form-control"
                            formControlName="seatNumber"
                            placeholder="e.g., 12A"
                            [class.is-invalid]="passenger.get('seatNumber')?.invalid && passenger.get('seatNumber')?.touched"
                          />
                          <div class="invalid-feedback">Seat number required</div>
                        </div>

                        <!-- Meal -->
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Meal Preference *</label>
                          <select
                            class="form-select"
                            formControlName="meal"
                            [class.is-invalid]="passenger.get('meal')?.invalid && passenger.get('meal')?.touched"
                          >
                            <option value="">Select Meal</option>
                            <option value="VEG">Vegetarian</option>
                            <option value="NON_VEG">Non-Vegetarian</option>
                            <option value="VEGAN">Vegan</option>
                            <option value="NONE">No Meal</option>
                          </select>
                          <div class="invalid-feedback">Meal preference required</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Total Amount -->
              <div class="alert alert-info">
                <strong>Total Amount:</strong> ₹{{ calculateTotalAmount() }}
                <span class="ms-3">({{ passengers.length }} passenger{{ passengers.length > 1 ? 's' :  '' }})</span>
              </div>

              <!-- Success Message -->
              <div class="alert alert-success" *ngIf="bookingSuccess">
                <h5>✅ Booking Successful!</h5>
                <p class="mb-1"><strong>PNR:</strong> {{ bookingResponse?.pnr }}</p>
                <p class="mb-0">Confirmation email sent to {{ bookingResponse?.email }}</p>
                <button type="button" class="btn btn-sm btn-outline-success mt-2" (click)="viewTicket()">View Ticket</button>
              </div>

              <!-- Error Message -->
              <div class="alert alert-danger" *ngIf="bookingError">
                <strong>Booking Failed:</strong> {{ errorMessage }}
              </div>

              <!-- Buttons -->
              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" class="btn btn-secondary" routerLink="/search">Cancel</button>
                <button 
                  type="submit" 
                  class="btn btn-success btn-lg"
                  [disabled]="bookingForm.invalid || isLoading || bookingSuccess"
                >
                  <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                  {{ isLoading ? 'Processing.. .' : 'Confirm Booking' }}
                </button>
              </div>

            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>